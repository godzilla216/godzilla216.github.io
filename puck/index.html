<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Puck Duel</title>
<style>
  body {
    background: #222;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
  }
  canvas {
    background: #0a5;
    border: 4px solid #333;
    margin-top: 10px;
  }
  #info {
    margin-top: 10px;
    font-size: 18px;
  }
  #scoreboard {
  display: flex;
  justify-content: space-between;
  width: 800px;
  margin: 0 auto;
  font-size: 20px;
  font-weight: bold;
}

#p1Score {
  color: #f44;
}

#p2Score {
  color: #44f;
}

#roundCounter {
  font-size: 18px;
  margin-bottom: 6px;
}

.active-player {
  text-shadow: 0 0 10px white;
}

#winOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  z-index: 10;
}

#winText {
  color: white;
}

</style>
</head>
<body>

<h1>Puck Duel</h1>
<div id="info">Player 1: Aim puck 1</div>
<div id="scoreboard">
  <span id="p1Score">Player 1: 3</span>
  <span id="p2Score">Player 2: 3</span>
</div>

<div id="roundCounter">Round 1</div>


<canvas id="game" width="800" height="500"></canvas>

<div id="winOverlay">
  <div id="winText"></div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const info = document.getElementById("info");

const BOARD_MARGIN = 20;
const PUCK_RADIUS = 12;
const FRICTION = 0.99;

const p1Score = document.getElementById("p1Score");
const p2Score = document.getElementById("p2Score");

let currentPlayer = 1;
let currentPuckIndex = 0;
let aiming = false;
let aimStart = null;
let phase = "aim";
let aimCurrent = null;
let roundNumber = 1;


const pucks = [];

function updateScoreboard() {
  const p1 = getActivePucks(1).length;
  const p2 = getActivePucks(2).length;

  p1Score.textContent = `Player 1: ${p1}`;
  p2Score.textContent = `Player 2: ${p2}`;

  p1Score.classList.toggle("active-player", currentPlayer === 1 && phase === "aim");
  p2Score.classList.toggle("active-player", currentPlayer === 2 && phase === "aim");
}

function createPucks() {
  pucks.length = 0;
  for (let i = 0; i < 3; i++) {
    pucks.push({
      x: 150,
      y: 150 + i * 60,
      vx: 0,
      vy: 0,
      player: 1,
      active: true,
      opacity: 1,
      shake: 0,
      eliminated: false
    });
    pucks.push({
      x: 650,
      y: 150 + i * 60,
      vx: 0,
      vy: 0,
      player: 2,
      active: true,
      opacity: 1,
      shake: 0,
      eliminated: false
    });
  }
}

createPucks();

function getCurrentPuck() {
  const list = getActivePucks(currentPlayer);
  return list[currentPuckIndex] || null;
}

canvas.addEventListener("mousedown", e => {
  if (phase !== "aim") return;
  const puck = getCurrentPuck();
  if (!puck || !puck.active) return;

  aiming = true;
  aimCurrent = getMouse(e);
});

canvas.addEventListener("mousemove", e => {
  if (!aiming) return;
  aimCurrent = getMouse(e);
});


canvas.addEventListener("mouseup", e => {
  if (!aiming) return;
  aiming = false;

  const puck = getCurrentPuck();
  const end = getMouse(e);

  puck.vx = (puck.x - end.x) * 0.1;
  puck.vy = (puck.y - end.y) * 0.1;

  aimCurrent = null;

  currentPuckIndex++;

  if (currentPuckIndex >= getActivePucks(currentPlayer).length) {
    currentPuckIndex = 0;
    currentPlayer = currentPlayer === 1 ? 2 : 1;
    }
    if (
    currentPlayer === 1 &&
    currentPuckIndex === 0 &&
    phase === "aim"
  ) {

    phase = "move";
    info.textContent = "Round in progress...";
  } else {
    info.textContent = `Player ${currentPlayer}: Aim puck ${currentPuckIndex + 1}`;
  }
});

function getMouse(e) {
  const rect = canvas.getBoundingClientRect();
  return {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top
  };
}

function update() {
  if (phase === "move") {
    let moving = false;

    for (let p of pucks) {
      if (!p.active) continue;

      p.x += p.vx;
      p.y += p.vy;
      p.vx *= FRICTION;
      p.vy *= FRICTION;

      if (Math.abs(p.vx) > 0.05 || Math.abs(p.vy) > 0.05) {
        moving = true;
      }
		if (p.eliminated) {
        p.opacity -= 0.05;
        p.shake *= 0.8;

        if (p.opacity <= 0) {
          p.active = false;
        }
      }

      if (
        p.x < BOARD_MARGIN ||
        p.x > canvas.width - BOARD_MARGIN ||
        p.y < BOARD_MARGIN ||
        p.y > canvas.height - BOARD_MARGIN
      ) {
        if (!p.eliminated) {
          p.eliminated = true;
          p.shake = 10;
        }

      }
    }

    handleCollisions();

    if (!moving) {
      resetRound();
    }
  }
}

function handleCollisions() {
  for (let i = 0; i < pucks.length; i++) {
    for (let j = i + 1; j < pucks.length; j++) {
      const a = pucks[i];
      const b = pucks[j];
      if (!a.active || !b.active) continue;

      const dx = b.x - a.x;
      const dy = b.y - a.y;
      const dist = Math.hypot(dx, dy);

      if (dist < PUCK_RADIUS * 2) {
        const nx = dx / dist;
        const ny = dy / dist;

        const p = 2 * (a.vx * nx + a.vy * ny - b.vx * nx - b.vy * ny) / 2;

        a.vx -= p * nx;
        a.vy -= p * ny;
        b.vx += p * nx;
        b.vy += p * ny;
      }
    }
  }
}

function resetRound() {
  for (let p of pucks) {
    p.vx = 0;
    p.vy = 0;
  }
  phase = "aim";
  currentPlayer = 1;
  currentPuckIndex = 0;
  info.textContent = "Player 1: Aim puck 1";
  roundNumber++;
document.getElementById("roundCounter").textContent = `Round ${roundNumber}`;

  checkWin();
}

function checkWin() {
  const p1 = getActivePucks(1).length;
  const p2 = getActivePucks(2).length;

  if (p1 === 0 || p2 === 0) {
    const winner = p1 === 0 ? 2 : 1;
    awardMatchPoint(winner);
  }
}


function getActivePucks(player) {
  return pucks.filter(p => p.player === player && p.active);
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.strokeStyle = "#000";
  ctx.strokeRect(
    BOARD_MARGIN,
    BOARD_MARGIN,
    canvas.width - BOARD_MARGIN * 2,
    canvas.height - BOARD_MARGIN * 2
  );

  for (let p of pucks) {
    if (!p.active) continue;
      ctx.save();
      ctx.globalAlpha = p.opacity;

      const shakeX = (Math.random() - 0.5) * p.shake;
      const shakeY = (Math.random() - 0.5) * p.shake;

      ctx.beginPath();
      ctx.arc(p.x + shakeX, p.y + shakeY, PUCK_RADIUS, 0, Math.PI * 2);
      ctx.fillStyle = p.player === 1 ? "#f44" : "#44f";
      ctx.fill();
	  ctx.restore();

  }

  if (aiming && aimCurrent) {
    const puck = getCurrentPuck();
    if (puck) {
      ctx.beginPath();
      ctx.moveTo(puck.x, puck.y);
      ctx.lineTo(aimCurrent.x, aimCurrent.y);
      ctx.strokeStyle = "white";
      ctx.lineWidth = 2;
      ctx.stroke();
    }
  }
}

function loop() {
  update();
  draw();
  updateScoreboard();
  requestAnimationFrame(loop);
}

loop();
</script>

</body>
</html>
