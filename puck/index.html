<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Puck Multiplayer Game</title>

<style>
body { margin:0; background:#222; color:white; font-family:Arial; text-align:center; }
button { padding:10px 16px; margin:6px; font-size:16px; cursor:pointer; }
canvas { background:#1b5e20; border:5px solid #8d6e63; touch-action:none; display:block; margin:auto; }
#scoreboard { display:flex; justify-content:space-between; padding:10px 20px; font-weight:bold; }
.p1 { background:#29b6f6; padding:8px 14px; border-radius:20px; }
.p2 { background:#ef5350; padding:8px 14px; border-radius:20px; }
#overlay { position:fixed; inset:0; background:rgba(0,0,0,.9); display:flex; align-items:center; justify-content:center; z-index:10; }
#box { background:#333; padding:20px; border-radius:12px; max-width:320px; text-align:center; }
input { padding:6px; margin:4px; width:120px; }
</style>
</head>

<body>

<div id="overlay">
  <div id="box">
    <h3>Choose Mode</h3>
    <button onclick="startLocal()">Local Multiplayer</button>
    <button onclick="showOnline()">Online Multiplayer</button>

    <div id="online" style="display:none; margin-top:10px;">
      <button onclick="createRoom()">Create Room</button><br><br>
      <input id="roomCode" placeholder="Room Code">
      <button onclick="joinRoom()">Join</button>
    </div>
  </div>
</div>

<div id="scoreboard">
  <div class="p1">P1: <span id="p1count">3</span></div>
  <div id="status">Waiting...</div>
  <div class="p2">P2: <span id="p2count">3</span></div>
</div>

<canvas id="game" width="800" height="500"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue, get, update as fbUpdate } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDxoIs6Nn5dMCpPj8JjNqbv-O3SVpiac0A",
  authDomain: "login-6cdd8.firebaseapp.com",
  databaseURL: "https://login-6cdd8-default-rtdb.firebaseio.com",
  projectId: "login-6cdd8",
  storageBucket: "login-6cdd8.firebasestorage.app",
  messagingSenderId: "518535069226",
  appId: "1:518535069226:web:8925106a250805bbf24d53"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ================= GAME STATE ================= */
let mode = "local";
let roomId = null;
let isHost = false;
let myPlayer = null;

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const W = canvas.width, H = canvas.height;

const R = 12;
const FRICTION = 0.99;
const BASE_SPEED = 0.15;

let pucks = [];
let phase = "aim";
let index = 0;
let aiming = false;
let pointer = {x:0,y:0};

/* ================= INIT ================= */
function initPucks(){
  pucks = [];
  for(let i=0;i<3;i++){
    pucks.push({x:300+i*60,y:H-60,vx:0,vy:0,owner:1});
    pucks.push({x:300+i*60,y:60,vx:0,vy:0,owner:2});
  }
}
initPucks();
updateScore();

/* ================= UI ================= */
function updateScore(){
  document.getElementById("p1count").innerText = pucks.filter(p=>p.owner===1).length;
  document.getElementById("p2count").innerText = pucks.filter(p=>p.owner===2).length;
}
function updateStatus(t){
  document.getElementById("status").innerText = t;
}

/* ================= MODE FUNCTIONS ================= */
window.startLocal = function(){
  mode="local";
  document.getElementById("overlay").style.display="none";
  updateStatus("Player 1: Your turn");
};

window.showOnline = function(){
  document.getElementById("online").style.display="block";
};

window.createRoom = async function(){
  mode="online";
  isHost=true;
  myPlayer=1;
  roomId=Math.random().toString(36).substring(2,7);

  await set(ref(db,"rooms/"+roomId),{
    pucks,
    index:0,
    phase:"aim",
    currentTurn:1
  });

  alert("Room Code: "+roomId);
  document.getElementById("overlay").style.display="none";
  listenRoom();
};

window.joinRoom = async function(){
  const code=document.getElementById("roomCode").value;
  const snap=await get(ref(db,"rooms/"+code));
  if(!snap.exists()) return alert("Room not found");

  mode="online";
  isHost=false;
  myPlayer=2;
  roomId=code;

  document.getElementById("overlay").style.display="none";
  listenRoom();
};

/* ================= ONLINE SYNC ================= */
function listenRoom(){
  onValue(ref(db,"rooms/"+roomId), snap=>{
    if(!snap.exists()) return;
    const d=snap.val();
    pucks=d.pucks;
    index=d.index;
    phase=d.phase;
    updateScore();

    updateStatus(
      d.currentTurn===myPlayer
        ? "Your turn"
        : "Waiting for opponent..."
    );
  });
}

function syncRoom(){
  if(!isHost) return;
  fbUpdate(ref(db,"rooms/"+roomId),{
    pucks,
    index,
    phase,
    currentTurn: pucks[index]?.owner ?? null
  });
}

/* ================= INPUT ================= */
function getPos(e){
  const r=canvas.getBoundingClientRect();
  const t=e.touches?e.touches[0]:e;
  return {x:t.clientX-r.left,y:t.clientY-r.top};
}

canvas.addEventListener("mousedown",startAim);
canvas.addEventListener("touchstart",startAim);
canvas.addEventListener("mousemove",moveAim);
canvas.addEventListener("touchmove",moveAim);
canvas.addEventListener("mouseup",releaseAim);
canvas.addEventListener("touchend",releaseAim);

function startAim(e){
  if(phase!=="aim") return;
  if(mode==="online" && pucks[index].owner!==myPlayer) return;
  aiming=true;
  pointer=getPos(e);
}
function moveAim(e){
  if(!aiming) return;
  pointer=getPos(e);
}
function releaseAim(){
  if(!aiming) return;
  const p=pucks[index];
  const dx=pointer.x-p.x;
  const dy=pointer.y-p.y;
  p.vx=dx*BASE_SPEED;
  p.vy=dy*BASE_SPEED;
  aiming=false;
  index++;
  if(mode==="online") syncRoom();
}

/* ================= GAME LOOP ================= */
function updateGame(){
  if(phase==="play" && (mode!=="online"||isHost)){
    pucks.forEach(p=>{
      p.x+=p.vx;
      p.y+=p.vy;
      p.vx*=FRICTION;
      p.vy*=FRICTION;
    });

    if(pucks.every(p=>Math.abs(p.vx)<0.05 && Math.abs(p.vy)<0.05)){
      pucks.forEach(p=>p.vx=p.vy=0);
      phase="aim";
      index=0;
      if(mode==="online") syncRoom();
    }
  }
}

function draw(){
  ctx.clearRect(0,0,W,H);
  pucks.forEach(p=>{
    ctx.beginPath();
    ctx.arc(p.x,p.y,R,0,Math.PI*2);
    ctx.fillStyle=p.owner===1?"#29b6f6":"#ef5350";
    ctx.fill();
  });

  if(aiming){
    const p=pucks[index];
    ctx.strokeStyle="yellow";
    ctx.beginPath();
    ctx.moveTo(p.x,p.y);
    ctx.lineTo(pointer.x,pointer.y);
    ctx.stroke();
  }
}

function loop(){
  updateGame();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
